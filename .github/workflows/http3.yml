name: HTTP3 Tests (MsQuic)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  DOTNET_NOLOGO: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  OMNIRELAY_ENABLE_HTTP3_TESTS: true

jobs:
  http3-ci-container:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build CI image with HTTP/3 support (libmsquic on Alpine)
        id: build
        run: |
          docker build \
            --file Dockerfile.ci \
            --target ci \
            --progress=plain \
            -t omnirelay-ci-http3 .

      - name: Extract artifacts from CI image
        if: ${{ steps.build.outcome == 'success' }}
        id: extract
        run: |
          container_id=$(docker create omnirelay-ci-http3)
          echo "container_id=${container_id}" >> $GITHUB_OUTPUT
          mkdir -p artifacts/test-results artifacts/coverage
          docker cp "${container_id}:/repo/artifacts/test-results/." artifacts/test-results || true
          docker cp "${container_id}:/repo/artifacts/coverage/." artifacts/coverage || true
          docker rm "${container_id}" || true

      - name: Report test results
        if: ${{ always() && steps.extract.outcome == 'success' }}
        uses: dorny/test-reporter@v2
        with:
          name: HTTP3 Tests
          path: artifacts/test-results/**/*.trx
          reporter: dotnet-trx

      - name: Upload coverage
        if: ${{ steps.extract.outcome == 'success' }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: artifacts/coverage/**/*.xml
          fail_ci_if_error: false
          verbose: true

      - name: Upload artifacts
        if: ${{ always() && steps.extract.outcome == 'success' }}
        uses: actions/upload-artifact@v5
        with:
          name: http3-artifacts
          path: |
            artifacts/test-results/**/*.trx
            artifacts/coverage
          if-no-files-found: ignore
