x-mesh-demo-build: &mesh-demo-build
  context: ../..
  dockerfile: samples/ResourceLease.MeshDemo/Dockerfile

services:
  mesh-dispatcher:
    build: *mesh-demo-build
    image: mesh-demo:latest
    container_name: mesh-dispatcher
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      DOTNET_gcServer: "1"
      MESHDEMO_meshDemo__rpcUrl: http://0.0.0.0:7421
      MESHDEMO_meshDemo__rpcClientUrl: http://mesh-dispatcher:7421
      MESHDEMO_meshDemo__roles: dispatcher,diagnostics
      MESHDEMO_meshDemo__dataDirectory: mesh-data
    ports:
      - "7421:7421"
      - "5158:8080"
    volumes:
      - mesh-data:/app/mesh-data
    networks:
      - mesh

  mesh-seeder:
    image: mesh-demo:latest
    container_name: mesh-seeder
    depends_on:
      - mesh-dispatcher
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      MESHDEMO_meshDemo__roles: seeder
      MESHDEMO_meshDemo__rpcClientUrl: http://mesh-dispatcher:7421
      MESHDEMO_meshDemo__seederIntervalSeconds: "2"
    networks:
      - mesh

  mesh-worker-a:
    image: mesh-demo:latest
    container_name: mesh-worker-a
    depends_on:
      - mesh-dispatcher
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      MESHDEMO_meshDemo__roles: worker
      MESHDEMO_meshDemo__rpcClientUrl: http://mesh-dispatcher:7421
      MESHDEMO_meshDemo__workerPeerId: mesh-worker-a
    networks:
      - mesh

  mesh-worker-b:
    image: mesh-demo:latest
    container_name: mesh-worker-b
    depends_on:
      - mesh-dispatcher
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      MESHDEMO_meshDemo__roles: worker
      MESHDEMO_meshDemo__rpcClientUrl: http://mesh-dispatcher:7421
      MESHDEMO_meshDemo__workerPeerId: mesh-worker-b
    networks:
      - mesh

  prometheus:
    image: prom/prometheus:v2.51.2
    container_name: mesh-prometheus
    depends_on:
      - mesh-dispatcher
      - mesh-seeder
      - mesh-worker-a
      - mesh-worker-b
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    ports:
      - "9090:9090"
    networks:
      - mesh

  grafana:
    image: grafana/grafana:10.4.2
    container_name: mesh-grafana
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SERVER_DOMAIN: localhost
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    networks:
      - mesh

volumes:
  mesh-data:

networks:
  mesh:
    driver: bridge
